<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room: La Ruta del Burlador</title>
    
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Cargar Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fuentes -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:ital,wght@0,400;0,700;1,400&display=swap');
        body { font-family: 'Lato', sans-serif; background-color: #1a1a1a; color: #e5e5e5; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .pattern-bg {
            background-image: radial-gradient(#4b4b4b 1px, transparent 1px);
            background-size: 20px 20px;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONOS SVG ---
        const LockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;
        const UnlockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>;
        const KeyIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>;
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const CheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="green" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;

        // --- HELPER DE TIEMPO ---
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // --- COMPONENTE DE SALA GEN√âRICO ---
        const Room = ({ title, subtitle, description, question, placeholder, correctAnswers, nextState, itemAwarded, onCheck, feedback, shake, image, currentStep }) => {
            const [inputValue, setInputValue] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onCheck(inputValue, correctAnswers, nextState, itemAwarded);
                if (!feedback) setInputValue(''); 
            };

            // C√°lculo de bolitas de progreso
            const totalSteps = 6;
            const steps = Array.from({ length: totalSteps }, (_, i) => i + 1);

            return (
                <div className="min-h-screen flex items-center justify-center p-4 pattern-bg">
                    <div className={`max-w-xl w-full bg-stone-900 border border-stone-700 p-8 rounded-lg shadow-2xl ${shake ? 'shake' : ''}`}>
                        
                        {/* Cabecera de la Sala */}
                        <div className="flex justify-between items-start mb-6 border-b border-stone-700 pb-4">
                            <div>
                                <h2 className="text-sm text-amber-600 font-bold uppercase tracking-widest mb-1">{title}</h2>
                                <h1 className="text-3xl font-cinzel text-stone-100">{subtitle}</h1>
                            </div>
                            <div className="text-4xl filter grayscale opacity-50 hover:grayscale-0 transition-all cursor-help" title="Pista visual">
                                {image}
                            </div>
                        </div>

                        {/* Descripci√≥n Narrativa */}
                        <div className="bg-stone-800/50 p-4 rounded border-l-4 border-amber-700 mb-8">
                            <p className="text-stone-300 leading-relaxed font-serif italic">
                                "{description}"
                            </p>
                        </div>

                        {/* √Årea de Desaf√≠o */}
                        <div className="space-y-4">
                            <label className="block text-amber-500 font-bold mb-2 flex items-center gap-2">
                                <LockIcon /> Desaf√≠o:
                            </label>
                            <p className="text-white mb-4">{question}</p>
                            
                            <form onSubmit={handleSubmit} className="relative">
                                <input 
                                    type="text" 
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    placeholder={placeholder}
                                    className="w-full bg-stone-950 border border-stone-600 rounded p-4 text-white focus:border-amber-500 focus:outline-none focus:ring-1 focus:ring-amber-500 transition-all"
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    className="absolute right-2 top-2 bg-stone-700 hover:bg-amber-700 text-white p-2 rounded transition-colors"
                                >
                                    <UnlockIcon />
                                </button>
                            </form>
                            
                            {feedback && (
                                <p className="text-red-400 text-sm mt-2 font-bold flex items-center gap-2 animate-pulse">
                                    <span>‚ö†Ô∏è</span> {feedback}
                                </p>
                            )}
                        </div>

                        {/* Pie de p√°gina con Progreso Din√°mico */}
                        <div className="mt-8 flex justify-between items-center text-xs text-stone-600">
                            <span>El Burlador de Sevilla ‚Ä¢ Jornada I</span>
                            <div className="flex gap-1">
                                {steps.map(step => (
                                    <div key={step} className={`h-2 w-2 rounded-full ${step <= currentStep ? 'bg-amber-500' : 'bg-stone-700'}`}></div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE WRAPPER PARA EL RELOJ ---
        // Se define FUERA de App para evitar que se re-renderice (monte/desmonte) cada segundo.
        const RoomWrapper = ({ formattedTime, ...props }) => (
            <div className="relative">
                {/* Timer Flotante */}
                <div className="fixed top-4 right-4 bg-stone-900/90 border border-amber-500/50 text-amber-500 px-4 py-2 rounded-full font-mono text-xl shadow-lg z-50 flex items-center gap-2">
                    <ClockIcon className="w-5 h-5" />
                    {formattedTime}
                </div>
                <Room {...props} />
            </div>
        );

        // --- COMPONENTE PRINCIPAL ---
        const App = () => {
            const [gameState, setGameState] = useState('intro'); // intro, room1, room2, room3, room4, room5, victory
            const [feedback, setFeedback] = useState('');
            const [shake, setShake] = useState(false);
            const [inventory, setInventory] = useState([]);
            
            const [playerName, setPlayerName] = useState('');
            const [elapsedSeconds, setElapsedSeconds] = useState(0);
            const [timerActive, setTimerActive] = useState(false);

            // Efecto del Cron√≥metro
            useEffect(() => {
                let interval = null;
                if (timerActive) {
                    interval = setInterval(() => {
                        setElapsedSeconds(seconds => seconds + 1);
                    }, 1000);
                } else if (!timerActive && elapsedSeconds !== 0) {
                    clearInterval(interval);
                }
                return () => clearInterval(interval);
            }, [timerActive, elapsedSeconds]);

            // --- L√ìGICA DE NIVELES ---
            const startGame = () => {
                if (playerName.trim() === '') {
                    setFeedback('Por favor ingresa tu nombre de agente.');
                    setShake(true);
                    setTimeout(() => setShake(false), 500);
                    return;
                }
                setFeedback('');
                setInventory([]);
                setElapsedSeconds(0);
                setTimerActive(true);
                setGameState('room1');
            };

            const checkAnswer = (answer, correctAnswers, nextState, itemAwarded) => {
                const normalizedAnswer = answer.toLowerCase().trim();
                const isCorrect = correctAnswers.some(a => normalizedAnswer.includes(a));

                if (isCorrect) {
                    setFeedback('');
                    if (itemAwarded) setInventory([...inventory, itemAwarded]);
                    
                    if (nextState === 'victory') {
                        setTimerActive(false); // Detener el tiempo al ganar
                    }
                    
                    setGameState(nextState);
                } else {
                    setFeedback('Respuesta incorrecta. Int√©ntalo de nuevo.');
                    setShake(true);
                    setTimeout(() => setShake(false), 500);
                }
            };

            // --- PANTALLAS ---
            
            // 1. INTRODUCCI√ìN
            if (gameState === 'intro') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 pattern-bg">
                        <div className={`max-w-2xl w-full bg-stone-900 border-2 border-amber-600 p-8 rounded-lg shadow-2xl text-center ${shake ? 'shake' : ''}`}>
                            <h1 className="text-4xl md:text-5xl font-cinzel text-amber-500 mb-6">El Misterio del Burlador</h1>
                            <p className="text-lg text-stone-300 mb-6 leading-relaxed">
                                A√±o 1630. Eres un investigador real encargado de aclarar los esc√°ndalos ocurridos recientemente. 
                                Un hombre desconocido ha deshonrado a mujeres nobles y plebeyas desde Italia hasta Espa√±a.
                            </p>
                            
                            <div className="bg-stone-800 p-6 rounded mb-8 border border-stone-700">
                                <label className="block text-amber-500 font-bold mb-2 text-left text-sm uppercase tracking-wide">
                                    Identificaci√≥n del Agente
                                </label>
                                <div className="flex items-center gap-3">
                                    <UserIcon className="text-stone-400" />
                                    <input 
                                        type="text" 
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        placeholder="Ingresa tu nombre..."
                                        className="w-full bg-stone-950 border border-stone-600 rounded p-3 text-white focus:border-amber-500 focus:outline-none"
                                        onKeyDown={(e) => e.key === 'Enter' && startGame()}
                                    />
                                </div>
                                {feedback && <p className="text-red-400 text-sm mt-2 text-left">{feedback}</p>}
                            </div>

                            <p className="text-md text-stone-400 mb-8 italic">
                                Tu misi√≥n ser√° cronometrada. ¬°La velocidad es crucial!
                            </p>
                            
                            <button 
                                onClick={startGame}
                                className="bg-amber-700 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded transition-colors duration-300 flex items-center justify-center mx-auto gap-2 w-full md:w-auto"
                            >
                                <KeyIcon /> Comenzar Misi√≥n
                            </button>
                        </div>
                    </div>
                );
            }

            const currentTime = formatTime(elapsedSeconds);

            // 2. SALA 1: N√ÅPOLES
            if (gameState === 'room1') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 1: El Palacio Real de N√°poles"
                        subtitle="La Oscuridad y el Enga√±o"
                        description="Te encuentras en los pasillos oscuros del Palacio Real. Se escuchan gritos. Una mujer, la Duquesa Isabela, clama haber sido deshonrada. El culpable huye saltando por el balc√≥n."
                        question="Para atrapar al culpable, primero debes entender el enga√±o. ¬øDe qu√© noble fingi√≥ ser Don Juan para entrar en la habitaci√≥n de Isabela?"
                        placeholder="Escribe el nombre del personaje..."
                        correctAnswers={['octavio', 'duque octavio']}
                        nextState="room1b"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={1}
                        image="üåë"
                    />
                );
            }

            if (gameState === 'room1b') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 1: El C√≥mplice"
                        subtitle="La Traici√≥n Familiar"
                        description="¬°Correcto! Fingi√≥ ser Octavio. Pero el culpable fue interceptado por la guardia real. Sin embargo, logr√≥ escapar."
                        question="El Rey de N√°poles encarg√≥ la captura a un hombre de confianza, pero este hombre result√≥ ser t√≠o del criminal y lo dej√≥ escapar. ¬øQui√©n es este personaje?"
                        placeholder="Nombre del t√≠o..."
                        correctAnswers={['pedro', 'don pedro', 'pedro tenorio']}
                        nextState="room2"
                        itemAwarded="Linterna de N√°poles"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={2}
                        image="üõ°Ô∏è"
                    />
                );
            }

            // 3. SALA 2: CASA DE OCTAVIO
            if (gameState === 'room2') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 2: Casa del Duque Octavio"
                        subtitle="La Acusaci√≥n Falsa"
                        description="Has llegado a la casa del verdadero Duque Octavio. Est√° confundido. Don Pedro Tenorio acaba de llegar con una noticia terrible: lo acusa a √©l de haber deshonrado a Isabela."
                        question="Octavio, temiendo la ira del Rey y creyendo que Isabela le fue infiel, decide no defenderse. ¬øHacia qu√© pa√≠s decide huir para salvar su vida?"
                        placeholder="Pa√≠s de destino..."
                        correctAnswers={['espa√±a', 'espana']}
                        nextState="room3"
                        itemAwarded="Mapa del Mediterr√°neo"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={3}
                        image="üìú"
                    />
                );
            }

            // 4. SALA 3: TARRAGONA
            if (gameState === 'room3') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 3: Costa de Tarragona"
                        subtitle="Fuego y Mar"
                        description="Siguiendo el rastro, llegas a la costa espa√±ola. Hubo un naufragio. Una pescadora llamada Tisbea, que antes se burlaba de los hombres, est√° llorando frente a su caba√±a incendiada."
                        question="Don Juan sedujo a Tisbea no con fuerza, sino con una palabra sagrada que ella crey√≥. ¬øQu√© le prometi√≥ Don Juan para que ella se entregara?"
                        placeholder="¬øQu√© prometi√≥? (Una palabra)"
                        correctAnswers={['matrimonio', 'casamiento', 'casarse', 'esposo', 'marido']}
                        nextState="room4"
                        itemAwarded="Promesa Rota"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={4}
                        image="üî•"
                    />
                );
            }

            // 5. SALA 4: CATALIN√ìN
            if (gameState === 'room4') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 4: La Voz de la Conciencia"
                        subtitle="El Criado"
                        description="Don Juan no viaja solo. Tiene un criado que, aunque leal, teme el castigo divino y constantemente advierte a su amo sobre las consecuencias de sus actos."
                        question="¬øCu√°l es el nombre de este criado que sirve de contrapunto c√≥mico y moral a Don Juan?"
                        placeholder="Nombre del criado..."
                        correctAnswers={['catalin√≥n', 'catalinon']}
                        nextState="room5"
                        itemAwarded="Advertencia de Catalin√≥n"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={5}
                        image="üó£Ô∏è"
                    />
                );
            }

            // 6. SALA 5: LA HUIDA FINAL
            if (gameState === 'room5') {
                return (
                    <RoomWrapper 
                        formattedTime={currentTime}
                        title="Sala 5: La Huida"
                        subtitle="El Robo Final"
                        description="Don Juan decide huir inmediatamente despu√©s de 'gozar' a Tisbea. Para hacerlo m√°s r√°pido, comete un robo, dejando a Tisbea deshonrada y sin medios de transporte."
                        question="¬øQu√© animales pertenecientes a Tisbea rob√≥ Don Juan para escapar hacia Sevilla?"
                        placeholder="Nombre de los animales..."
                        correctAnswers={['yeguas', 'caballos', 'yegua', 'caballo']}
                        nextState="victory"
                        itemAwarded="Riendas Robadas"
                        onCheck={checkAnswer}
                        feedback={feedback}
                        shake={shake}
                        currentStep={6}
                        image="üêé"
                    />
                );
            }

            // 7. VICTORIA
            if (gameState === 'victory') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 pattern-bg">
                        <div className="max-w-2xl bg-stone-900 border-2 border-green-600 p-8 rounded-lg shadow-2xl text-center animate-fade-in relative overflow-hidden">
                            {/* Marca de Agua "CONFIDENCIAL" */}
                            <div className="absolute top-10 left-[-50px] transform -rotate-45 text-stone-800 text-8xl font-black pointer-events-none opacity-20 select-none">
                                RESUELTO
                            </div>

                            <div className="flex justify-center mb-6 relative z-10">
                                <div className="p-4 bg-green-900 rounded-full">
                                    <CheckCircle />
                                </div>
                            </div>
                            <h1 className="text-4xl font-cinzel text-green-500 mb-2 relative z-10">¬°Caso Resuelto!</h1>
                            
                            {/* Tarjeta de Reporte de Agente */}
                            <div className="bg-stone-800 border-l-4 border-amber-500 p-4 mb-6 text-left mx-auto max-w-sm shadow-lg relative z-10">
                                <div className="text-xs text-stone-500 uppercase tracking-widest mb-1">Reporte Final</div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-stone-400">Agente:</span>
                                    <span className="text-xl font-bold text-white capitalize">{playerName}</span>
                                </div>
                                <div className="flex justify-between items-center border-t border-stone-700 pt-2">
                                    <span className="text-stone-400">Tiempo Total:</span>
                                    <span className="text-2xl font-mono text-amber-400 font-bold">{currentTime}</span>
                                </div>
                            </div>
                            
                            <div className="bg-stone-800 p-6 rounded-lg text-left mb-8 border border-stone-700 max-h-60 overflow-y-auto relative z-10">
                                <h3 className="text-amber-500 font-bold mb-4 border-b border-stone-600 pb-2">Resumen del Expediente:</h3>
                                <ul className="space-y-3 text-stone-300 text-sm">
                                    <li className="flex items-start gap-2">
                                        <span className="text-green-500">‚úì</span> 
                                        <span><strong>N√°poles:</strong> Don Juan enga√±a a Isabela fingiendo ser Octavio. Don Pedro encubre su huida.</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-green-500">‚úì</span> 
                                        <span><strong>Huida:</strong> El inocente Duque Octavio huye a Espa√±a acusado injustamente.</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-green-500">‚úì</span> 
                                        <span><strong>Tarragona:</strong> Don Juan seduce a Tisbea con promesa de <em>matrimonio</em>.</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-green-500">‚úì</span> 
                                        <span><strong>C√≥mplice:</strong> Catalin√≥n acompa√±a y advierte a Don Juan, pero no impide sus actos.</span>
                                    </li>
                                    <li className="flex items-start gap-2">
                                        <span className="text-green-500">‚úì</span> 
                                        <span><strong>Final:</strong> Huyen robando las yeguas de Tisbea, dej√°ndola gritando "¬°Fuego!".</span>
                                    </li>
                                </ul>
                            </div>

                            <button 
                                onClick={() => {
                                    setGameState('intro'); 
                                    setInventory([]); 
                                    setPlayerName(''); 
                                    setElapsedSeconds(0);
                                }}
                                className="mt-4 text-stone-400 hover:text-white underline relative z-10"
                            >
                                Iniciar Nueva Investigaci√≥n
                            </button>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>